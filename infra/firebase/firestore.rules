rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /// ---- HELPERS ----
    function isSignedIn() {
      return request.auth != null;
    }

    function isGameParticipant(data) {
      return isSignedIn() &&
        (request.auth.uid == data.challengerId ||
         request.auth.uid == data.defenderId);
    }

    function canUpdateGameStatus(before, after) {
      // Only allow status changes from PENDING_ACCEPT to ACTIVE or DECLINED
      // and only by the defender.
      return isSignedIn()
        && request.auth.uid == before.defenderId
        && before.status == "PENDING_ACCEPT"
        && (
          after.status == "ACTIVE" ||
          after.status == "DECLINED"
        );
    }

    function isValidNewGame(data) {
      // Enforce initial state for new game documents
      return data.status == "PENDING_ACCEPT"
        && !("winnerId" in data)
        && !("finishedAt" in data)
        && data.currentTurn == "CHALLENGER"
        && data.lettersWord == "SKATE"
        && data.challengerLetters == ""
        && data.defenderLetters == "";
    }

    /// ---- USER DOCS ----
    match /users/{uid} {
      allow read: if true;  // public profiles allowed
      allow write: if isSignedIn() && request.auth.uid == uid;
    }

    /// ---- GAMES COLLECTION ----
    match /games/{gameId} {
      allow read: if isGameParticipant(resource.data);

      allow create: if isSignedIn()
        && request.resource.data.challengerId == request.auth.uid
        && isValidNewGame(request.resource.data);

      allow update: if isGameParticipant(resource.data)
        && (
          // Either status is NOT being changed at all...
          !("status" in request.resource.data.diff().affectedKeys())
          // ...or we are explicitly allowed to change it via Accept/Decline
          || canUpdateGameStatus(resource.data, request.resource.data)
        );

      allow delete: if false;
    }

    /// ---- ROUNDS COLLECTION ----
    match /rounds/{roundId} {
      allow read: if true; // Or restrict to participants if you prefer

      // Allow creation of rounds (setting a trick)
      allow create: if isSignedIn()
        && request.resource.data.attackerId == request.auth.uid;
        
      // Allow updates (defender replying)
      allow update: if isSignedIn();
    }
    
    /// ---- TURNS COLLECTION (Legacy/Deprecated?) ----
    match /turns/{turnId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
  }
}
